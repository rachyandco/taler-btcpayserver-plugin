@* Server-level Taler settings form (merchant config, assets, bank accounts).
   Inputs: TalerServerConfigViewModel from UITalerServerController.
   Output: admin actions/forms to save settings and call provisioning endpoints. *@
@model BTCPayServer.Plugins.Taler.Controllers.ViewModels.TalerServerConfigViewModel
@{
    ViewData["Title"] = "Taler";
}

<h2 class="mb-4">Taler settings</h2>

<form method="post" asp-action="GetServerConfig">
    <div class="form-group mb-3">
        <label asp-for="MerchantBaseUrl" class="form-label"></label>
        <input asp-for="MerchantBaseUrl" class="form-control" placeholder="https://merchant.example.com/" />
        <div class="form-text">Base URL of your Taler merchant backend.</div>
    </div>
    <div class="form-group mb-3">
        <label asp-for="MerchantPublicBaseUrl" class="form-label"></label>
        <input asp-for="MerchantPublicBaseUrl" class="form-control" placeholder="https://pay.example.com/taler/" />
        <div class="form-text">Optional public URL used in `taler+` payment links. Set this when your merchant backend is behind reverse proxy/path rewriting.</div>
    </div>
    <div class="form-group mb-3">
        <label asp-for="MerchantInstanceId" class="form-label"></label>
        <input asp-for="MerchantInstanceId" class="form-control" placeholder="default" />
        <div class="form-text">Leave empty to use the default instance.</div>
    </div>
    <div class="form-group mb-3">
        <label asp-for="InstancePassword" class="form-label"></label>
        <div class="input-group">
            <input asp-for="InstancePassword"
                   class="form-control"
                   type="password"
                   autocomplete="off"
                   value="@Model.InstancePassword" />
            <button class="btn btn-outline-secondary px-3 only-for-js" type="button"
                    title="Show or hide value"
                    aria-label="Show or hide instance password"
                    data-toggle-password="#InstancePassword">
                <span aria-hidden="true">&#128065;</span>
            </button>
        </div>
        <div class="form-text">Password used to initialize and manage the instance.</div>
    </div>
    <div class="form-group mb-4">
        <label asp-for="ApiToken" class="form-label"></label>
        <div class="input-group">
            <input asp-for="ApiToken"
                   class="form-control"
                   type="password"
                   autocomplete="off"
                   value="@Model.ApiToken" />
            <button class="btn btn-outline-secondary px-3 only-for-js" type="button"
                    title="Show or hide value"
                    aria-label="Show or hide API token"
                    data-toggle-password="#ApiToken">
                <span aria-hidden="true">&#128065;</span>
            </button>
        </div>
        <div class="form-text">Provide the merchant API token (secret-token:...)
            for private APIs. For full self-provisioning from this UI, the token must include account-management permissions.</div>
    </div>

    <div class="d-flex gap-2 mb-4">
        <button type="submit" class="btn btn-outline-primary" formaction="@Url.Action("InitInstance")" formmethod="post">Initialize instance</button>
        <button type="submit" class="btn btn-outline-secondary" formaction="@Url.Action("GenerateToken")" formmethod="post">Generate API token</button>
        <button type="submit" class="btn btn-outline-secondary" formaction="@Url.Action("RefreshBankAccounts")" formmethod="post">Check bank accounts</button>
    </div>

    <div class="d-flex align-items-center justify-content-between mb-2">
        <h4 class="mb-0">Assets</h4>
        <button type="submit" class="btn btn-outline-secondary" formaction="@Url.Action("RefreshAssets")" formmethod="post">Fetch assets</button>
    </div>

    <table class="table table-striped">
        <thead>
            <tr>
                <th>Code</th>
                <th>Name</th>
                <th>Divisibility</th>
                <th>Symbol</th>
                <th>Enabled</th>
                <th>Source</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        @if (Model.Assets.Any())
        {
            for (var i = 0; i < Model.Assets.Count; i++)
            {
                <tr>
                    <td>
                        @Model.Assets[i].AssetCode
                        <input type="hidden" asp-for="Assets[i].AssetCode" />
                    </td>
                    <td>
                        <input class="form-control" asp-for="Assets[i].DisplayName" />
                    </td>
                    <td>
                        <input class="form-control" asp-for="Assets[i].Divisibility" />
                    </td>
                    <td>
                        <input class="form-control" asp-for="Assets[i].Symbol" />
                    </td>
                    <td>
                        <input class="form-check-input" asp-for="Assets[i].Enabled" />
                    </td>
                    <td>
                        @(Model.Assets[i].IsManual ? "Manual" : "Discovered")
                        <input type="hidden" asp-for="Assets[i].IsManual" />
                    </td>
                    <td>
                        @if (Model.Assets[i].IsManual)
                        {
                            <button type="submit" class="btn btn-link p-0" formaction="@Url.Action("DeleteAsset", new { assetCode = Model.Assets[i].AssetCode })" formmethod="post">Remove</button>
                        }
                    </td>
                </tr>
            }
        }
        else
        {
            <tr>
                <td colspan="7" class="text-muted">No assets configured yet.</td>
            </tr>
        }
        </tbody>
    </table>

    <button type="submit" class="btn btn-primary">Save</button>
</form>

<hr class="my-4" />

<div class="d-flex align-items-center justify-content-between mb-2">
    <h4 class="mb-0">Bank accounts</h4>
</div>
@if (!string.IsNullOrWhiteSpace(Model.BankAccountsError))
{
    <div class="alert alert-warning">
        Could not load bank accounts: @Model.BankAccountsError
    </div>
}
<table class="table table-striped">
    <thead>
        <tr>
            <th>Payto URI</th>
            <th>H_wire</th>
            <th>Active</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
    @if (Model.BankAccounts.Any())
    {
        foreach (var account in Model.BankAccounts)
        {
            <tr>
                <td><code>@account.PaytoUri</code></td>
                <td><code>@account.HWire</code></td>
                <td>
                    <span class="me-2 btcpay-status btcpay-status--@(account.Active ? "enabled" : "pending")"></span>
                    @(account.Active ? "Yes" : "No")
                </td>
                <td>
                    <form method="post" asp-action="DeleteBankAccount" asp-route-hWire="@account.HWire">
                        <input type="hidden" name="MerchantBaseUrl" value="@Model.MerchantBaseUrl" />
                        <input type="hidden" name="MerchantInstanceId" value="@Model.MerchantInstanceId" />
                        <input type="hidden" name="ApiToken" value="@Model.ApiToken" />
                        <button type="submit" class="btn btn-link p-0">Delete</button>
                    </form>
                </td>
            </tr>
        }
    }
    else
    {
        <tr>
            <td colspan="4" class="text-muted">No bank accounts found for this instance.</td>
        </tr>
    }
    </tbody>
</table>

<div class="d-flex align-items-center justify-content-between mb-2 mt-4">
    <h4 class="mb-0">KYC status</h4>
</div>
@if (!string.IsNullOrWhiteSpace(Model.KycError))
{
    <div class="alert alert-warning">
        Could not load KYC status: @Model.KycError
    </div>
}
<table class="table table-striped">
    <thead>
        <tr>
            <th>Payto URI</th>
            <th>Exchange</th>
            <th>Status</th>
            <th>KYC instructions (payto)</th>
            <th>Limits</th>
        </tr>
    </thead>
    <tbody>
    @if (Model.KycEntries.Any())
    {
        foreach (var entry in Model.KycEntries)
        {
            <tr>
                <td>
                    <code>@entry.PaytoUri</code>
                </td>
                <td>
                    <div><code>@entry.ExchangeUrl</code></div>
                    <div class="text-muted">@entry.ExchangeCurrency</div>
                </td>
                <td>
                    <div><strong>@entry.Status</strong></div>
                    @if (entry.AuthConflict)
                    {
                        <div class="text-warning">auth conflict</div>
                    }
                    @if (entry.NoKeys)
                    {
                        <div class="text-warning">exchange keys unavailable</div>
                    }
                    @if (entry.ExchangeHttpStatus is not null || entry.ExchangeCode is not null)
                    {
                        <div class="text-muted">HTTP @entry.ExchangeHttpStatus / code @entry.ExchangeCode</div>
                    }
                </td>
                <td>
                    @if (entry.PaytoKycAuths.Any())
                    {
                        foreach (var instruction in entry.PaytoKycAuths)
                        {
                            <div><code>@instruction</code></div>
                        }
                    }
                    else
                    {
                        <span class="text-muted">No KYC payment instruction</span>
                    }
                </td>
                <td>
                    @if (entry.Limits.Any())
                    {
                        foreach (var limit in entry.Limits)
                        {
                            <div class="mb-1">
                                <strong>@limit.OperationType</strong>:
                                @limit.Threshold
                                over @FormatTimeframe(limit.TimeframeMicros)
                                (@(limit.SoftLimit ? "soft" : "hard"))
                            </div>
                        }
                    }
                    else
                    {
                        <span class="text-muted">No limits returned</span>
                    }
                </td>
            </tr>
        }
    }
    else
    {
        <tr>
            <td colspan="5" class="text-muted">No KYC status data available.</td>
        </tr>
    }
    </tbody>
</table>

<h4>Add bank account</h4>
<form method="post" asp-action="AddBankAccount">
    <input type="hidden" name="MerchantBaseUrl" value="@Model.MerchantBaseUrl" />
    <input type="hidden" name="MerchantInstanceId" value="@Model.MerchantInstanceId" />
    <input type="hidden" name="ApiToken" value="@Model.ApiToken" />
    <div class="row g-3">
        <div class="col-md-8">
            <label class="form-label" for="NewPaytoUri">Payto URI</label>
            <input class="form-control" id="NewPaytoUri" name="PaytoUri" placeholder="payto://..." />
        </div>
        <div class="col-md-4">
            <label class="form-label" for="NewCreditFacadeUrl">Credit facade URL (optional)</label>
            <input class="form-control" id="NewCreditFacadeUrl" name="CreditFacadeUrl" placeholder="https://..." />
        </div>
    </div>
    <button type="submit" class="btn btn-outline-primary mt-3">Add bank account</button>
</form>

@functions
{
    private static string FormatTimeframe(long micros)
    {
        if (micros <= 0)
            return "all-time";

        var ts = TimeSpan.FromMilliseconds(micros / 1000.0);
        if (ts.TotalDays >= 365 && Math.Abs(ts.TotalDays % 365) < 0.01)
            return $"{(int)(ts.TotalDays / 365)} year(s)";
        if (ts.TotalDays >= 1 && Math.Abs(ts.TotalDays % 1) < 0.01)
            return $"{(int)ts.TotalDays} day(s)";
        if (ts.TotalHours >= 1 && Math.Abs(ts.TotalHours % 1) < 0.01)
            return $"{(int)ts.TotalHours} hour(s)";
        if (ts.TotalMinutes >= 1 && Math.Abs(ts.TotalMinutes % 1) < 0.01)
            return $"{(int)ts.TotalMinutes} minute(s)";
        return $"{(int)ts.TotalSeconds} second(s)";
    }
}
